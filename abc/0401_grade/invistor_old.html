<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta content="telephone=no" name="format-detection">
    <meta name="keywords" content="土豆,土豆泥直播,土豆泥">
    <meta name="description" content="土豆泥直播,最高端的手机视频直播">
    <title>土豆泥邀请</title>
    <link rel="stylesheet" href="https://h5.tudouni.doubozhibo.com/tudouni/css/number_Invitation.css">
    <style>
        * {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            -webkit-tap-highlight-color: transparent;
            tap-highlight-color: rgba(0, 0, 0, 0);
        }
    </style>
    <script src="https://h5.tudouni.doubozhibo.com/tudouni/js/jquery.js"></script>
    <script src="https://h5.tudouni.doubozhibo.com/tudouni/js/whyInvistor.js"></script>
    <script src="https://h5.tudouni.doubozhibo.com/tudouni/js/clipboard.min.js"></script>
</head>

<body>
    <div id="center">
        <div class="header">
            <img src="https://image.tudouni.doubozhibo.com/common/h5/banner@3x.png">
        </div>
        <div class="size1">
            <span id="nickname"></span>邀请你加入土豆泥直播</div>
        <div class="size2">马上组团去赚钱吧!</div>
        <div class="size3" id="noties"></div>
    </div>
    <form class="form-inline">
        <div class="form-group one">
            <input type="number" class="form-phone" id="phone" placeholder="11位手机号" oninput="if(value.length>11)value=value.slice(0,11)">
            <img src="https://image.tudouni.doubozhibo.com/common/h5/phone_number@3x.png">
        </div>
        <div class="form-group two">
            <input type="number" class="form-control" id="phoneCode" placeholder="6位验证码" oninput="if(value.length>6)value=value.slice(0,6)">
            <img src="https://image.tudouni.doubozhibo.com/common/h5/verification_code@3x.png">
            <div class="code" id="codeBtn">获取验证码</div>
        </div>
    </form>
    <div class="key" id="bindBtn"></div>
</body>
    <script>
        //短信验证
        var time = 60;
        $(function () {
            
            //获邀请人昵称、邀请码
            var nickName = getUrlParam("nickName");
            if(nickName!=null){
                nickName = decodeURI(nickName);
            }
            $("#nickname").text(nickName);
            var tcode = decodeURI(getUrlParam("code"));
            var invistor = getUrlParam("unionid");

            //获取短信验证码
            var validCode = true;
            //var domain = "http://118.31.9.209:8080";
            var domain = "https://waptest.tudouni.doubozhibo.com";

            $("#phone").keydown(function () {
                var txt = $("#phone").val();
                $("#codeBtn").removeClass("msgs1").removeClass("msgs2");
                if (txt.length >= 10) {
                    $(".code").addClass("msgs2");
                } else {
                    $(".code").addClass("msgs1");
                }
            });

            $("#codeBtn").click(function () {
                if (checkPhone($("#phone").val()) == false) {
                    showNoties("手机号格式错误");
                    return;
                }
                if (time == 60 && $("#phone").val().length == 11) {
                    $.ajax({
                        type: "get",
                        //url: "http://118.31.9.209:8080/h5/phoneCode?phone=" + $("#phone").val(),
                        url: domain + "/h5/user/invite/getVerifCode",
                        data: {
                            phone: $("#phone").val(),
                            inviterUnionid: invistor
                        },
                        success: function (data) {
                            if (data.code == 0) {
                                settime();
                            } else {
                                showNoties(data.msg);
                            }
                        },
                        error: function () {
                            showNoties("获取验证码失败");
                        }
                    });
                }
            });

            $("#bindBtn").click(function () {
                if (checkPhone($("#phone").val()) == false) {
                    showNoties("请输入正确的手机号");
                    return;
                }
                if ($("#phoneCode").val() == "") {
                    showNoties("请输入验证码");
                    return;
                }

                //绑定
                // 3.0之前：  var url = "http://118.31.9.209:8080/h5/loginAndBind?phone=" + $("#phone").val() + "&code=" + $("#phoneCode").val() + "&invistor=" + invistor;
                $.ajax({
                    type: "get",
                    url: domain + "/h5/user/invite/action/addBindingRequest",
                    data: {
                        phone: $("#phone").val(),
                        code: $("#phoneCode").val(),
                        inviterUnionid: invistor
                    },
                    success: function (data) {
                        if (data.code == 0) {
                            showNoties("恭喜你，绑定成功");

                            // setTimeout(function () {
                            //     window.location.href = "https://a.app.qq.com/o/simple.jsp?pkgname=com.doubozhibo.tudouni";
                            // }, 3000);
                        } else {
                            showNoties(data.msg);
                            //复制邀请码到剪切板
                            var clipboard = new ClipboardJS('#bindBtn', {
                                text: function() {
                                    return '#tdn'+ tcode + '#tdn' + $("#phone").val();
                                }
                            });
                        
                            clipboard.on('success', function(e) {
                                console.log(e);
                            });
                        
                            clipboard.on('error', function(e) {
                                console.log(e);
                            });
                        }
                    },
                    error: function () {
                        showNoties("绑定失败");
                    }
                });
            });
        });

        function showNoties(msg) {
            $("#noties").text(msg);
            $("#noties").css("display", "block");
            setTimeout(function () {
                $("#noties").text("");
                $("#noties").css("display", "none");
            }, 1500);
        }

        function settime() {
            if (time == 0) {
                $("#codeBtn").removeClass("msgs1").removeClass("msgs2");
                $("#codeBtn").html("重新获取");
                $("#codeBtn").addClass("msgs2");
                time = 60;
            } else {
                time--;
                $("#codeBtn").removeClass("msgs1").removeClass("msgs2");
                $("#codeBtn").addClass("msgs1");
                $("#codeBtn").html(time + "s");
                setTimeout(function () {
                    settime()
                }, 1000)
            }

        }

        function getUrlParam(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return r[2];
            return null;
        }

        function checkPhone(phone) {
            if (!(/^1(3|4|5|7|8)\d{9}$/.test(phone))) {
                return false;
            }
            return true;
        }
    </script>
</html>